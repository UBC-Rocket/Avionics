//#include "MPL.h"
//#include "MPU.h"
//#include <i2c_t3.h>
#include <inttypes.h>
#include <stdio.h>

#define BUFFER_SIZE 500

//MPL alt = new MPL(0);
//MPU pos = new MPU(0);
int16_t gyroReadings[BUFFER_SIZE][3];
int16_t accelReadings[BUFFER_SIZE][3];
int16_t magReadings[BUFFER_SIZE][3];
float altReadings[BUFFER_SIZE];

float testData[] = {-5.55, -5.55, -5.55, 1.70, 1.70, 1.70, 1.70, -2.17, -2.17, -2.17, -2.17, 7.64, 7.64, 7.64, 7.64, 1.02, 1.02, 1.02, 1.02, -1.42, -1.42, -1.42, -1.42, -0.30, -0.30, -0.30, -0.30, 0.27, 0.27, 0.27, 0.27, 0.77, 0.77, 0.77, 0.77, -4.30, -4.30, -4.30, -4.30, -0.42, -0.42, -0.42, -0.42, -0.17, -0.17, -0.17, -0.17, 0.02, 0.02, 0.02, 0.02, 0.52, 0.52, 0.52, 0.52, -0.11, -0.11, -0.11, -0.11, -1.30, -1.30, -1.30, -1.30, -0.30, -0.30, -0.30, -0.30, 1.02, 1.02, 1.02, 1.02, -2.61, -2.61, -2.61, -2.61, -0.61, -0.61, -0.61, -0.61, -4.11, -4.11, -4.11, -4.11, -4.23, -4.23, -4.23, -4.23, 0.39, 0.39, 0.39, 0.39, 1.27, 1.27, 1.27, 1.27, 0.27, 0.27, 0.27, 0.27, -0.73, -0.73, -0.73, -0.73, -0.42, -0.42, -0.42, -0.42, 1.14, 1.14, 1.14, 1.14, -2.23, -2.23, -2.23, -2.23, -2.61, -2.61, -2.61, -2.61, -0.80, -0.80, -0.80, -0.80, 3.52, 3.52, 3.52, 3.52, 1.14, 1.14, 1.14, 1.14, -3.80, -3.80, -3.80, -3.80, -5.05, -5.05, -5.05, -5.05, -3.55, -3.55, -3.55, -3.55, -2.61, -2.61, -2.61, -2.61, 0.70, 0.70, 0.70, 0.70, -3.42, -3.42, -3.42, -3.42, -4.67, -4.67, -4.67, -4.67, -1.67, -1.67, -1.67, -1.67, -2.17, -2.17, -2.17, -2.17, -1.67, -1.67, -1.67, -1.67, -0.67, -0.67, -0.67, -0.67, -0.73, -0.73, -0.73, -0.73, 1.77, 1.77, 1.77, 1.77, -6.30, -6.30, -6.30, -6.30, -4.11, -4.11, -4.11, -4.11, -4.36, -4.36, -4.36, -4.36, 2.89, 2.89, 2.89, 2.89, -1.98, -1.98, -1.98, -1.98, -0.86, -0.86, -0.86, -0.86, -2.80, -2.80, -2.80, -2.80, -5.48, -5.48, -5.48, -5.48, -1.61, -1.61, -1.61, -1.61, -1.98, -1.98, -1.98, -1.98, 1.83, 1.83, 1.83, 1.83, -1.67, -1.67, -1.67, -1.67, 0.08, 0.08, 0.08, 0.08, 0.27, 0.27, 0.27, 0.27, -0.61, -0.61, -0.61, -0.61, -3.55, -3.55, -3.55, -3.55, -0.05, -0.05, -0.05, -0.05, -7.61, -7.61, -7.61, -7.61, -2.36, -2.36, -2.36, -2.36, 1.70, 1.70, 1.70, 1.70, -1.23, -1.23, -1.23, -1.23, 2.20, 2.20, 2.20, 2.20, -2.36, -2.36, -2.36, -2.36, -0.55, -0.55, -0.55, -0.55, 2.14, 2.14, 2.14, 2.14, -7.30, -7.30, -7.30, -7.30, -1.17, -1.17, -1.17, -1.17, -4.30, -4.30, -4.30, -4.30, -0.92, -0.92, -0.92, -0.92, -0.55, -0.55, -0.55, -0.55, -1.55, -1.55, -1.55, -1.55, 1.27, 1.27, 1.27, 1.27, -3.55, -3.55, -3.55, -3.55, -2.11, -2.11, -2.11, -2.11, 1.02, 1.02, 1.02, 1.02, -1.11, -1.11, -1.11, -1.11, -4.61, -4.61, -4.61, -4.61, -2.92, -2.92, -2.92, -2.92, -3.55, -3.55, -3.55, -3.55, -1.42, -1.42, -1.42, -1.42, 2.95, 2.95, 2.95, 2.95, -2.67, -2.67, -2.67, -2.67, -1.36, -1.36, -1.36, -1.36, 1.27, 1.27, 1.27, 1.27, -4.36, -4.36, -4.36, -4.36};

float filteredAltReadings[BUFFER_SIZE];
float kalmanError;
float predictionError = 1;

int bufPosition = 1;
int writePosition = 0;

void readData();
void filterData();
void writeBuffer();

int main() {
  for(int i = 0; i < 200; i++) {
    filterData();
    printf("%f\n", filteredAltReadings[bufPosition]);
  }

  return 0;
}

void readData() {
  bufPosition++;

  //gyroReadings[bufPosition] = MPU.readGyro();
  //accelReadings[bufPosition] = MPU.readAccel();
  //magReadings[bufPosition] = MPU.readMag();
  //altReadings[bufPosition] = MPL.readAltitude();

  if(bufPosition >= BUFFER_SIZE) writeBuffer();
}

void filterData() {
  readData();
  kalmanError = predictionError/(predictionError + 0.75);
  filteredAltReadings[bufPosition] = filteredAltReadings[bufPosition - 1] +
    kalmanError * (testData[bufPosition] - filteredAltReadings[bufPosition - 1]);
  predictionError = predictionError * (1 - kalmanError);
}

void writeBuffer() {
  for(int i = 0; i < BUFFER_SIZE; i++) {
    //write buffer element of each data type to sd card at write position.
    writePosition++;
  }
  bufPosition = 0;
}
